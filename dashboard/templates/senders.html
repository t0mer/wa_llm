{% extends "base.html" %}

{% block title %}Senders - WhatsApp LLM Dashboard{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">Senders</div>
    
    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by sender name or JID..." onkeyup="filterTable()">
        <span class="search-info" id="searchInfo"></span>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>JID</th>
                <th>Push Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if senders %}
                {% for sender in senders %}
                <tr>
                    <td class="text-truncate" title="{{ sender.jid }}">{{ sender.jid }}</td>
                    <td>{{ sender.push_name or 'N/A' }}</td>
                    <td class="actions">
                        <button onclick='showStatistics("{{ sender.jid }}")' class="btn-icon stats-btn" title="Statistics">ðŸ“Š</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="3" style="text-align: center; padding: 30px; color: #999;">No senders found</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <div class="pagination">
        <div class="pagination-info">
            Showing {{ ((page - 1) * page_size + 1) if total > 0 else 0 }} to {{ (page * page_size) if (page * page_size < total) else total }} of {{ total }} entries
        </div>
        <div class="pagination-controls">
            <select class="page-size-select" onchange="window.location.href='?page=1&page_size=' + this.value">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10 per page</option>
                <option value="20" {% if page_size == 20 %}selected{% endif %}>20 per page</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100 per page</option>
            </select>
            
            <div class="page-numbers">
                {% if page > 1 %}
                    <a href="?page={{ page - 1 }}&page_size={{ page_size }}" class="btn">Previous</a>
                {% else %}
                    <button class="btn" disabled>Previous</button>
                {% endif %}

                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <span class="page-number active">{{ p }}</span>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <a href="?page={{ p }}&page_size={{ page_size }}" class="page-number">{{ p }}</a>
                    {% elif p == page - 3 or p == page + 3 %}
                        <span class="page-number">...</span>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <a href="?page={{ page + 1 }}&page_size={{ page_size }}" class="btn">Next</a>
                {% else %}
                    <button class="btn" disabled>Next</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Modal -->
<div id="statsModal" class="modal">
    <div class="modal-content stats-modal-content">
        <span class="close" onclick="closeStatsModal()">&times;</span>
        <h2 id="statsSenderName">Sender Statistics</h2>
        
        <div class="time-frame-section">
            <label style="font-weight: 600; margin-bottom: 10px; display: block;">Time Frame</label>
            <div class="time-frame-buttons">
                <button class="time-btn active" data-days="7" onclick="selectTimeFrame(7)">7 Days</button>
                <button class="time-btn" data-days="30" onclick="selectTimeFrame(30)">30 Days</button>
                <button class="time-btn" data-days="90" onclick="selectTimeFrame(90)">90 Days</button>
            </div>
        </div>
        
        <div class="total-messages-box">
            <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Total Messages in Selected Time Frame</div>
            <div id="totalMessages" style="font-size: 24px; font-weight: bold; color: #4169E1;">0</div>
        </div>
        
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Messages Per Group</h3>
        <div class="chart-container">
            <canvas id="messagesChart"></canvas>
        </div>
        
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Detailed Breakdown</h3>
        <table class="stats-table detailed-table">
            <thead>
                <tr>
                    <th style="text-align: left;">GROUP</th>
                    <th style="text-align: center;">MESSAGES</th>
                    <th style="text-align: center;">PERCENTAGE</th>
                </tr>
            </thead>
            <tbody id="groupsTable">
                <tr>
                    <td colspan="3" style="text-align: center;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
    transition: transform 0.2s;
}

.btn-icon:hover {
    transform: scale(1.2);
}

.search-container {
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.search-input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
}

.search-info {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
}

.stats-modal-content {
    max-width: 900px;
    width: 90%;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

.actions {
    white-space: nowrap;
}

.time-frame-section {
    margin-bottom: 15px;
    padding: 10px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.time-frame-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
}

.time-btn {
    flex: 1;
    min-width: 80px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 600;
    color: #4a5568;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

.time-btn:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.time-btn:hover:before {
    left: 100%;
}

.time-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    border-color: #667eea;
    color: #667eea;
}

.time-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transform: translateY(-1px);
}

.time-btn.active:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.time-btn:active {
    transform: translateY(0);
}

.total-messages-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.total-messages-box #totalMessages {
    color: white !important;
}

.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.stats-table thead {
    background-color: #667eea;
    color: white;
}

.stats-table th {
    padding: 12px;
    font-weight: 600;
    text-align: left;
}

.stats-table td {
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
}

.stats-table tbody tr:hover {
    background-color: #f8f9fa;
}

.stats-table tbody tr:last-child td {
    border-bottom: none;
}
</style>

<script>
let currentSenderJid = null;
let currentChart = null;
let selectedDays = 7;
let allSenders = [];
let currentPageSenders = [];

// Store current page senders data on load
document.addEventListener('DOMContentLoaded', function() {
    // Store current page senders from the rendered table
    const rows = document.querySelectorAll('table tbody tr');
    currentPageSenders = Array.from(rows).map(row => {
        const jid = row.cells[0]?.getAttribute('title');
        if (!jid) return null;
        return {
            jid: jid,
            push_name: row.cells[1]?.textContent.trim()
        };
    }).filter(s => s !== null && s.push_name !== 'No senders found');
    
    loadAllSenders();
});

async function loadAllSenders() {
    try {
        const response = await fetch('/api/senders?page=1&page_size=10000');
        if (response.ok) {
            const data = await response.json();
            allSenders = data.items || [];
        }
    } catch (error) {
        console.error('Error loading all senders:', error);
        allSenders = currentPageSenders;
    }
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const dataSource = allSenders.length > 0 ? allSenders : currentPageSenders;
    
    if (!searchTerm) {
        renderTable(dataSource);
        document.getElementById('searchInfo').textContent = '';
        return;
    }
    
    const filteredSenders = dataSource.filter(sender => {
        const jid = (sender.jid || '').toLowerCase();
        const pushName = (sender.push_name || '').toLowerCase();
        return jid.includes(searchTerm) || pushName.includes(searchTerm);
    });
    
    renderTable(filteredSenders);
    document.getElementById('searchInfo').textContent = filteredSenders.length > 0 
        ? `Found ${filteredSenders.length} result${filteredSenders.length !== 1 ? 's' : ''}`
        : 'No results';
}

function renderTable(senders) {
    const tbody = document.querySelector('table tbody');
    
    if (senders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">No senders found</td></tr>';
        return;
    }
    
    tbody.innerHTML = senders.map(sender => {
        const pushName = sender.push_name === 'N/A' ? 'N/A' : (sender.push_name || 'N/A');
        return `
            <tr>
                <td class="text-truncate" title="${sender.jid}">${sender.jid}</td>
                <td>${pushName}</td>
                <td class="actions">
                    <button onclick='showStatistics("${sender.jid}")' class="btn-icon stats-btn" title="Statistics">ðŸ“Š</button>
                </td>
            </tr>
        `;
    }).join('');
}

async function showStatistics(senderJid) {
    currentSenderJid = senderJid;
    selectedDays = 7;
    document.getElementById('statsModal').style.display = 'block';
    
    // Reset buttons
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.time-btn[data-days="7"]').classList.add('active');
    
    await fetchStatistics(senderJid, selectedDays);
}

function selectTimeFrame(days) {
    selectedDays = days;
    
    // Update button states
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.time-btn[data-days="${days}"]`).classList.add('active');
    
    if (currentSenderJid) {
        fetchStatistics(currentSenderJid, days);
    }
}

function closeStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    currentSenderJid = null;
}

async function fetchStatistics(senderJid, days) {
    try {
        const response = await fetch(`/api/senders/${encodeURIComponent(senderJid)}/statistics?days=${days}`);
        
        if (response.ok) {
            const data = await response.json();
            
            // Update modal title
            document.getElementById('statsSenderName').textContent = 
                `Statistics: ${data.push_name || senderJid}`;
            
            // Update total messages
            document.getElementById('totalMessages').textContent = data.total_messages;
            
            // Update chart
            updateChart(data.messages_per_group);
            
            // Update groups table
            updateGroupsTable(data.messages_per_group, data.total_messages);
        }
    } catch (error) {
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load statistics: ' + error.message,
            confirmButtonColor: '#667eea'
        });
    }
}

function updateChart(messagesPerGroup) {
    const ctx = document.getElementById('messagesChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Prepare data - limit to top 10 groups for readability
    const topGroups = messagesPerGroup.slice(0, 10);
    const labels = topGroups.map(item => item.group_name);
    const data = topGroups.map(item => item.count);
    
    // Create new chart
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Messages',
                data: data,
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

function updateGroupsTable(messagesPerGroup, totalMessages) {
    const tbody = document.getElementById('groupsTable');
    
    if (messagesPerGroup.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No messages found</td></tr>';
        return;
    }
    
    tbody.innerHTML = messagesPerGroup.map((group) => {
        const percentage = totalMessages > 0 ? ((group.count / totalMessages) * 100).toFixed(1) : 0;
        return `
            <tr>
                <td style="font-weight: 500;">${group.group_name}</td>
                <td style="text-align: center; font-weight: bold;">${group.count}</td>
                <td style="text-align: center;">${percentage}%</td>
            </tr>
        `;
    }).join('');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('statsModal');
    if (event.target == modal) {
        closeStatsModal();
    }
}
</script>
{% endblock %}
