{% extends "base.html" %}

{% block title %}Messages - WhatsApp LLM Dashboard{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">Messages</div>
    
    <table>
        <thead>
            <tr>
                <th>Message ID</th>
                <th>Timestamp</th>
                <th>Sender JID</th>
                <th>Group JID</th>
                <th>Group Name</th>
                <th>Text</th>
                <th>Media URL</th>
            </tr>
        </thead>
        <tbody>
            {% if messages %}
                {% for message in messages %}
                <tr>
                    <td class="text-truncate" title="{{ message.message_id }}">{{ message.message_id }}</td>
                    <td>{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') if message.timestamp else 'N/A' }}</td>
                    <td class="text-truncate" title="{{ message.sender_jid }}">{{ message.sender_jid }}</td>
                    <td class="text-truncate" title="{{ message.group_jid }}">{{ message.group_jid or 'N/A' }}</td>
                    <td class="text-truncate" title="{{ message.group.group_name if message.group else '' }}">{{ message.group.group_name if message.group else 'N/A' }}</td>
                    <td class="text-truncate" title="{{ message.text }}">{{ message.text or 'N/A' }}</td>
                    <td class="text-truncate" title="{{ message.media_url }}">
                        {% if message.media_url %}
                            {% if message.media_url.startswith('http') %}
                                <a href="{{ message.media_url }}" target="_blank">View</a>
                            {% else %}
                                <a href="{{ whatsapp_host }}/{{ message.media_url }}" target="_blank">View</a>
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px; color: #999;">No messages found</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <div class="pagination">
        <div class="pagination-info">
            Showing {{ ((page - 1) * page_size + 1) if total > 0 else 0 }} to {{ (page * page_size) if (page * page_size < total) else total }} of {{ total }} entries
        </div>
        <div class="pagination-controls">
            <select class="page-size-select" onchange="window.location.href='?page=1&page_size=' + this.value">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10 per page</option>
                <option value="20" {% if page_size == 20 %}selected{% endif %}>20 per page</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100 per page</option>
            </select>
            
            <div class="page-numbers">
                {% if page > 1 %}
                    <a href="?page={{ page - 1 }}&page_size={{ page_size }}" class="btn">Previous</a>
                {% else %}
                    <button class="btn" disabled>Previous</button>
                {% endif %}

                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <span class="page-number active">{{ p }}</span>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <a href="?page={{ p }}&page_size={{ page_size }}" class="page-number">{{ p }}</a>
                    {% elif p == page - 3 or p == page + 3 %}
                        <span class="page-number">...</span>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <a href="?page={{ page + 1 }}&page_size={{ page_size }}" class="btn">Next</a>
                {% else %}
                    <button class="btn" disabled>Next</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
